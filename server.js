const express=require("express"),path=require("path"),bodyParser=require("body-parser"),dbModule=require("./config/db.js"),routes=require("./routes/index.js"),User=require("./dbSchemas/userSchema.js"),session=require("express-session"),bcrypt=require("bcrypt"),crypto=require("crypto"),flash=require("connect-flash"),cloudinary=require("cloudinary").v2,ProjectController=require("./controller/projectController.js"),port=process.env.PORT||8080,app=express(),generateSecretKey=()=>crypto.randomBytes(32).toString("hex"),secretKey=generateSecretKey();app.use(express.static(path.join(__dirname,"public"))),app.use(bodyParser.urlencoded({extended:!0})),app.use(express.json()),app.use(flash()),app.set("view engine","ejs"),app.set("views",path.join(__dirname,"views")),app.use((e,s,r)=>{s.locals.url=s=>`${e.protocol}://${e.get("host")}${s}`,r()}),app.use(session({secret:secretKey,resave:!1,saveUninitialized:!1}));const ensureAuthenticated=(e,s,r)=>{if(e.session&&e.session.user)return r();s.redirect("/login")};app.use((e,s,r)=>{s.locals.success_msg=e.flash("success_msg"),s.locals.error_msg=e.flash("error_msg"),r()}),app.use(express.static(path.join(__dirname,"public"))),app.get("/admin",ensureAuthenticated,(e,s)=>{let r=path.join(__dirname,"public","admin","admin.html");s.sendFile(r)}),app.get("/login",(e,s)=>{let r=path.join(__dirname,"public","admin","login.html");s.sendFile(r)}),app.get("/registration",(e,s)=>{let r=path.join(__dirname,"public","admin","registration.html");s.sendFile(r)}),app.post("/user-login",async(e,s)=>{let{email:r,password:t}=e.body;try{let o=await User.findOne({email:r});if(!o){e.flash("error_msg","Incorrect email"),s.redirect("/login");return}let p=await bcrypt.compare(t,o.password);if(!p){e.flash("error_msg","Incorrect password"),s.redirect("/login");return}e.session.user=o,e.flash("success_msg","Login successful"),s.redirect("/admin")}catch(a){console.error(a),e.flash("error_msg","An error occurred"),s.redirect("/login")}}),app.get("/project/:id",ProjectController.getProjectById),app.use("/",routes),app.get("/",(e,s)=>{s.send("Hello World")}),app.listen(port,()=>{console.log(`The application started successfully on port ${port}`)}),dbModule();